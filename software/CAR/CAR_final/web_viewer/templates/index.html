<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BottleSumo iPad Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sensor-bar-container { height: 25px; background-color: #e9ecef; border-radius: 4px; position: relative; overflow: hidden; }
        .sensor-bar { height: 100%; transition: width 0.1s ease; }
        .threshold-line { position: absolute; top: 0; bottom: 0; width: 2px; background-color: black; z-index: 10; }
        .status-indicator { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .control-panel { padding: 10px; }
        /* iPad specific adjustments */
        @media (max-width: 768px) {
            .container { padding-left: 10px; padding-right: 10px; }
            .btn-lg-touch { padding: 15px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Connection</h5>
                        <div class="row g-2 align-items-center">
                            <div class="col-md-4 col-6">
                                <input type="text" id="host" class="form-control" value="192.168.4.1" placeholder="Host">
                            </div>
                            <div class="col-md-2 col-3">
                                <input type="number" id="port" class="form-control" value="8080" placeholder="Port">
                            </div>
                            <div class="col-md-3 col-3">
                                <button id="btn-connect" class="btn btn-primary w-100">Connect</button>
                            </div>
                            <div class="col-md-3 col-12 text-end">
                                <span id="connection-status" class="badge bg-secondary">Disconnected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Sensors -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">IR Sensors (Edge)</div>
                    <div class="card-body" id="ir-sensors">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ToF Sensors (Tracking)</div>
                    <div class="card-body" id="tof-sensors">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls & State -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Test Mode</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Current Mode: <span id="current-mode" class="fw-bold">-</span></label>
                            <select id="mode-select" class="form-select mb-2">
                                <option value="AUTO">AUTO</option>
                                <option value="TEST_MOTOR">TEST_MOTOR</option>
                                <option value="TEST_SENSOR">TEST_SENSOR</option>
                                <option value="CALIBRATE_IR">CALIBRATE_IR</option>
                                <option value="CALIBRATE_TOF">CALIBRATE_TOF</option>
                            </select>
                            <button id="btn-set-mode" class="btn btn-secondary w-100">Set Mode</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Motor Control</div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="motor-enable">
                            <label class="form-check-label" for="motor-enable">Enable Transmission</label>
                        </div>
                        <div class="mb-3">
                            <label>Left Motor: <span id="val-m1">0</span></label>
                            <input type="range" class="form-range" id="range-m1" min="-100" max="100" value="0">
                        </div>
                        <div class="mb-3">
                            <label>Right Motor: <span id="val-m2">0</span></label>
                            <input type="range" class="form-range" id="range-m2" min="-100" max="100" value="0">
                        </div>
                        <div class="d-grid gap-2">
                            <button id="btn-stop" class="btn btn-danger btn-lg-touch">STOP</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Thresholds</div>
                    <div class="card-body">
                        <div id="threshold-controls">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">System Info</div>
                    <div class="card-body small">
                        <div>Timestamp: <span id="sys-timestamp">-</span></div>
                        <div>WiFi RSSI: <span id="sys-rssi">-</span></div>
                        <div>Heap: <span id="sys-heap">-</span></div>
                        <div>Action: <span id="sys-action">-</span></div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        Serial Logs
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearLogs()">Clear</button>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; padding: 10px; background: #222; color: #0f0;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        let isConnected = false;
        let motorEnabled = false;

        // UI Elements
        const btnConnect = document.getElementById('btn-connect');
        const statusBadge = document.getElementById('connection-status');
        const irContainer = document.getElementById('ir-sensors');
        const tofContainer = document.getElementById('tof-sensors');
        const thresholdContainer = document.getElementById('threshold-controls');
        const logContainer = document.getElementById('log-container');

        function clearLogs() {
            logContainer.innerHTML = '';
        }

        // Colors for sensors
        const sensorColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];
        const tofNames = ["Right (45)", "Right (23)", "Center", "Left (23)", "Left (45)"];

        // Initialize UI
        function initUI() {
            // IR Sensors
            let irHtml = '';
            for(let i=0; i<4; i++) {
                irHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Sensor ${i}</span>
                            <span id="ir-val-${i}">0.00V</span>
                        </div>
                        <div class="sensor-bar-container">
                            <div id="ir-bar-${i}" class="sensor-bar" style="width: 0%; background-color: ${sensorColors[i]};"></div>
                            <div id="ir-thresh-line-${i}" class="threshold-line" style="left: 61%;"></div> <!-- Default ~2.5V -->
                        </div>
                    </div>`;
            }
            irContainer.innerHTML = irHtml;

            // ToF Sensors
            let tofHtml = '';
            for(let i=0; i<5; i++) {
                tofHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${tofNames[i]}</span>
                            <span id="tof-val-${i}">- mm</span>
                        </div>
                        <div class="progress">
                            <div id="tof-bar-${i}" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>`;
            }
            tofContainer.innerHTML = tofHtml;

            // Threshold Controls
            let threshHtml = '';
            for(let i=0; i<4; i++) {
                threshHtml += `
                    <div class="input-group mb-2">
                        <span class="input-group-text">S${i}</span>
                        <input type="number" class="form-control" id="thresh-input-${i}" value="2.5" step="0.1" min="0" max="4.1">
                        <button class="btn btn-outline-secondary" onclick="setThreshold(${i})">Set</button>
                    </div>`;
            }
            thresholdContainer.innerHTML = threshHtml;
        }

        initUI();

        // Socket Events
        socket.on('status', (data) => {
            console.log('Status:', data);
            isConnected = data.connected;
            if (isConnected) {
                btnConnect.textContent = 'Disconnect';
                btnConnect.classList.replace('btn-primary', 'btn-danger');
                statusBadge.textContent = 'Connected';
                statusBadge.classList.replace('bg-secondary', 'bg-success');
            } else {
                btnConnect.textContent = 'Connect';
                btnConnect.classList.replace('btn-danger', 'btn-primary');
                statusBadge.textContent = 'Disconnected';
                statusBadge.classList.replace('bg-success', 'bg-secondary');
            }
        });

        socket.on('telemetry', (data) => {
            updateUI(data);
        });

        // Button Handlers
        btnConnect.addEventListener('click', () => {
            if (isConnected) {
                socket.emit('disconnect_robot');
            } else {
                const host = document.getElementById('host').value;
                const port = document.getElementById('port').value;
                socket.emit('connect_robot', { host, port });
            }
        });

        document.getElementById('btn-set-mode').addEventListener('click', () => {
            const mode = document.getElementById('mode-select').value;
            socket.emit('send_command', { command: `SET_MODE ${mode}` });
        });

        document.getElementById('motor-enable').addEventListener('change', (e) => {
            motorEnabled = e.target.checked;
            if (!motorEnabled) {
                stopMotors();
            }
        });

        const rangeM1 = document.getElementById('range-m1');
        const rangeM2 = document.getElementById('range-m2');
        
        function sendMotorCommand() {
            if (!motorEnabled) return;
            const m1 = rangeM1.value;
            const m2 = rangeM2.value;
            document.getElementById('val-m1').textContent = m1;
            document.getElementById('val-m2').textContent = m2;
            socket.emit('send_command', { command: `TEST_MOTOR ${m1} ${m2}` });
        }

        rangeM1.addEventListener('input', sendMotorCommand);
        rangeM2.addEventListener('input', sendMotorCommand);

        document.getElementById('btn-stop').addEventListener('click', stopMotors);

        function stopMotors() {
            rangeM1.value = 0;
            rangeM2.value = 0;
            document.getElementById('val-m1').textContent = 0;
            document.getElementById('val-m2').textContent = 0;
            socket.emit('send_command', { command: `TEST_MOTOR 0 0` });
        }

        window.setThreshold = function(idx) {
            const val = document.getElementById(`thresh-input-${idx}`).value;
            socket.emit('set_threshold', { cmd: 'set_threshold', sensor: idx, value: parseFloat(val) });
            // Update local line immediately for feedback
            const pct = (parseFloat(val) / 4.096) * 100;
            document.getElementById(`ir-thresh-line-${idx}`).style.left = `${pct}%`;
        };

        function updateUI(data) {
            // Handle Logs
            if (data.log) {
                const entry = document.createElement('div');
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${data.log}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
                // Limit logs to 100 lines
                if (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
                return; // If it's just a log, we might not have other data
            }

            // Parse data similar to viewer.py
            // IR Sensors
            const sensors = data.irsensors || data.sensors || {};
            const voltages = sensors.voltage || [];
            
            for(let i=0; i<4; i++) {
                if (voltages[i] !== undefined) {
                    const v = voltages[i];
                    document.getElementById(`ir-val-${i}`).textContent = v.toFixed(2) + 'V';
                    const pct = Math.min(100, (v / 4.096) * 100);
                    document.getElementById(`ir-bar-${i}`).style.width = `${pct}%`;
                }
            }

            // Update Threshold Lines if available
            if (sensors.edge_threshold) {
                for(let i=0; i<4; i++) {
                    const thresh = sensors.edge_threshold[i];
                    const pct = Math.min(100, (thresh / 4.096) * 100);
                    const line = document.getElementById(`ir-thresh-line-${i}`);
                    if(line) line.style.left = `${pct}%`;
                }
            }

            // ToF Sensors
            const tof = data.tof || data.tofsensors || {};
            const distances = tof.distance_mm || tof.distances || [];
            const valid = tof.valid || [];
            
            for(let i=0; i<5; i++) {
                if (distances[i] !== undefined) {
                    const d = distances[i];
                    document.getElementById(`tof-val-${i}`).textContent = d + ' mm';
                    
                    // Proximity logic: Closer = More filled
                    // Max 1500mm
                    let pct = 0;
                    if (d < 1500) {
                        pct = ((1500 - d) / 1500) * 100;
                    }
                    const bar = document.getElementById(`tof-bar-${i}`);
                    bar.style.width = `${pct}%`;
                    
                    // Color logic
                    bar.className = 'progress-bar';
                    if (d < 350) bar.classList.add('bg-danger');
                    else if (d < 1000) bar.classList.add('bg-warning');
                    else bar.classList.add('bg-success');
                }
            }

            // System Info
            if (data.system_info) {
                document.getElementById('sys-rssi').textContent = data.system_info.wifi_rssi || '-';
                document.getElementById('sys-heap').textContent = data.system_info.free_heap || '-';
            }
            if (data.robot_state) {
                document.getElementById('sys-action').textContent = data.robot_state.action || '-';
            }
            document.getElementById('sys-timestamp').textContent = data.timestamp || '-';
            
            if (data.test_mode) {
                document.getElementById('current-mode').textContent = data.test_mode;
            }
        }
    </script>
</body>
</html>
