```mermaid
flowchart TB
    subgraph GUI["GUI Client (Python/JavaScript)"]
        USER[User Interface]
        TCP_CLIENT[TCP Client]
    end
    
    subgraph WIFI["WiFi AP (192.168.4.1:4242)"]
        AP[BottleSumo_Robot]
        TCP_SERVER[TCP Server]
    end
    
    subgraph CORE0["RP2040 Core 0 - Control & WiFi"]
        CMD_PARSER[Command Parser]
        MODE_MGR[Mode Manager]
        
        subgraph TEST_MODULES["Test Mode Modules (Header-Only)"]
            COMMON[TestModeCommon.h<br/>Enums, State, Utils]
            MOTOR_TEST[MotorTestMode.h<br/>5 Functions]
            SENSOR_TEST[SensorTestMode.h<br/>8 Functions]
        end
        
        MOTOR_L[Motor Left<br/>GP11/12]
        MOTOR_R[Motor Right<br/>GP20/19]
        OLED[OLED Display<br/>Wire1]
        JSON_STREAM[JSON Streaming]
    end
    
    subgraph CORE1["RP2040 Core 1 - Sensors"]
        IR_READER[IR Reader]
        TOF_READER[ToF Reader]
        ADS[ADS1115<br/>4x IR Sensors<br/>Wire]
        VL[VL53L0X<br/>5x ToF Sensors<br/>Wire]
    end
    
    USER --> TCP_CLIENT
    TCP_CLIENT -->|Commands| AP
    AP --> TCP_SERVER
    TCP_SERVER --> CMD_PARSER
    
    CMD_PARSER -->|SET_MODE| MODE_MGR
    CMD_PARSER -->|TEST_MOTOR<br/>STOP_MOTOR<br/>GET_MOTOR| MOTOR_TEST
    CMD_PARSER -->|TEST_SENSOR<br/>CALIBRATE_IR<br/>CALIBRATE_TOF<br/>GET_CALIBRATION| SENSOR_TEST
    
    MODE_MGR --> COMMON
    MOTOR_TEST --> COMMON
    SENSOR_TEST --> COMMON
    
    MOTOR_TEST -->|PWM Control| MOTOR_L
    MOTOR_TEST -->|PWM Control| MOTOR_R
    
    SENSOR_TEST -->|Read IR| IR_READER
    SENSOR_TEST -->|Read ToF| TOF_READER
    
    IR_READER --> ADS
    TOF_READER --> VL
    
    JSON_STREAM -->|Real-time Data| TCP_SERVER
    TCP_SERVER -->|Stream| AP
    AP -->|Stream| TCP_CLIENT
    TCP_CLIENT -->|Display| USER
    
    MODE_MGR -->|Status| OLED
    MOTOR_TEST -->|PWM Values| OLED
    SENSOR_TEST -->|Cal Progress| OLED
    
    style COMMON fill:#90EE90
    style MOTOR_TEST fill:#87CEEB
    style SENSOR_TEST fill:#FFB6C1
    style MOTOR_L fill:#FFD700
    style MOTOR_R fill:#FFD700
```

## Test Mode Architecture Documentation

### Communication Flow
- **User → Robot:** TCP commands (text-based, newline-terminated)
- **Robot → User:** JSON streaming (10Hz, real-time sensor data)

### Core 0 (Control & WiFi)
- **Command Parser** (`handleClientCommand`, line 951+)
- **Mode Manager** (TestModeCommon.h): AUTO, TEST_MOTOR, TEST_SENSOR, CALIBRATE_IR, CALIBRATE_TOF
- **MotorTestMode.h** (5 functions): PWM control, stop, query, execute, JSON
- **SensorTestMode.h** (8 functions): test, calibrate, query, update, JSON builders

### Core 1 (Sensors)
- **IR Reader** (~860 SPS via ADS1115)
- **ToF Reader** (~10 Hz via VL53L0X)

### Hardware
- **Motors:** GP11/12 (left), GP20/19 (right), 20kHz PWM
- **Sensors:** 4x IR (ADS1115/Wire), 5x ToF (VL53L0X/Wire), OLED (Wire1)

### Safety
- 5-second timeout, PWM clamping (±100%), emergency stop, mode isolation
